[//]: # ( )
[//]: # (This file is automatically generated by the `jsarch`)
[//]: # (module. Do not change it elsewhere, changes would)
[//]: # (be overriden.)
[//]: # ( )
# Architecture Notes

## Summary

1. [Server run](#1-server-run)
2. [Server preparation](#2-server-preparation)
   1. [Root injections](#21-root-injections)
3. [Server environment](#3-server-environment)
   1. [`PWD` env var](#31-`pwd`-env-var)
   2. [`NODE_ENV`/`APP_ENV` env var](#32-`node_env`/`app_env`-env-var)
   3. [`WHOOK_PLUGINS` and `PROJECT_SRC`](#33-`whook_plugins`-and-`project_src`)
   4. [Logging](#34-logging)
   5. [Initializers](#35-initializers)
4. [Base URL](#4-base-url)
5. [`$autoload` service](#5-`$autoload`-service)
   1. [Configuration auto loading](#51-configuration-auto-loading)
      1. [Injecting handlers](#521-injecting-handlers)
   3. [API auto loading](#53-api-auto-loading)
   3. [Examples](#53-examples)
      1. [Typings generator](#531-typings-generator)
      2. [Open API generator](#532-open-api-generator)
   4. [Constants](#54-constants)
   4. [Testing](#54-testing)
   5. [Handlers map](#55-handlers-map)
   6. [Service/handler loading](#56-service/handler-loading)
      1. [WhookInitializerMap](#561-whookinitializermap)
   7. [Service name mapping](#57-service-name-mapping)
      1. [WhookServiceMap](#571-whookservicemap)
   8. [Initializer path mapping](#58-initializer-path-mapping)
6. [IP detection](#6-ip-detection)
7. [Port detection](#7-port-detection)
9. [Plugins paths](#9-plugins-paths)
10. [Commands](#10-commands)
10. [API definitions loader](#10-api-definitions-loader)


## 1. Server run

Whook exposes a `runServer` function to programmatically spawn
 its server. It is intended to be reusable and injectable so
 that projects can override the whole `whook` default behavior.

[See in context](./src/index.ts#L248-L252)



## 2. Server preparation

Whook exposes a `prepareServer` function to create its server
 configuration. It takes eventually additional injections that
 would be required at a higher level and a
 [Knifecycle](https://github.com/nfroidure/knifecycle)
 containing the bootstrapped environment and allowing
 to complete and run the server.

[See in context](./src/index.ts#L321-L328)



### 2.1. Root injections

* We need to inject `httpServer` and `process` to bring life to our
 *  server. We also inject `log` for logging purpose and custom other
 *  injected name that were required upfront.

[See in context](./src/index.ts#L342-L346)



## 3. Server environment

The Whook `prepareEnvironment` function aims to provide the complete
 server environment without effectively planning its run. It allows
 to use that environment for CLI or build purposes. It also
 provides a chance to override some services/constants
 before actually preparing the server.

[See in context](./src/index.ts#L356-L362)



### 3.1. `PWD` env var

The Whook server heavily rely on the process working directory
 to dynamically load contents. We are making it available to
 the DI system as a constant.

[See in context](./src/index.ts#L373-L377)



### 3.2. `NODE_ENV`/`APP_ENV` env var

Whook has different behaviors depending on their values.
 Consider setting it to production before shipping.

[See in context](./src/index.ts#L387-L390)



### 3.3. `WHOOK_PLUGINS` and `PROJECT_SRC`

Whook need to know where to look up for things like
 commands / handlers etc...

[See in context](./src/index.ts#L392-L395)



### 3.4. Logging

Whook's default logger write to the NodeJS default console
 except for debugging messages where it uses the `debug`
 module so that you can set the `DEBUG` environment
 variable to `whook` and get debug messages in output.

[See in context](./src/index.ts#L398-L403)



### 3.5. Initializers

Whook's embed a few default initializers proxied from
 `common-services`, `@whook/http-router` or its own
 `src/services` folder. It can be wrapped or overriden,
 at will, later in project's main file.

[See in context](./src/index.ts#L422-L427)



## 4. Base URL

The `BASE_URL` service is intended to provide a base URL where
 the API can be found at. It can be overriden directly via
 injecting it but it is useful to have a usable URL while
 debugging production environnement.

[See in context](./src/services/BASE_URL.ts#L5-L10)



## 5. `$autoload` service

The default Whook autoloader provides a simple way to
 load the constants, services and handlers of a Whook
 project automatically from the installed whook plugins.

[See in context](./src/services/_autoload.ts#L60-L64)



### 5.1. Configuration auto loading

Loading the configuration files is done according to the `APP_ENV`
   environment variable. It basically requires a configuration hash
   where the keys are Knifecycle constants.

  Let's load the configuration files as a convenient way
   to create constants on the fly

[See in context](./src/index.ts#L446-L453)



#### 5.2.1. Injecting handlers

A good thing is that you can reuse any handler into
   your commands by simply injecting it by name.

[See in context](./src/commands/generateOpenAPISchema.ts#L38-L42)



### 5.3. API auto loading

We cannot inject the `API` in the auto loader since
 it is dynamically loaded so doing this during the auto
 loader initialization.

[See in context](./src/services/_autoload.ts#L120-L124)



### 5.3. Examples

Whook's default project comes with a few sample commands.

[See in context](./src/commands/generateOpenAPITypes.ts#L8-L11)



#### 5.3.1. Typings generator

This command allows you to generate the API types that
 helps you to write your handler in a clean and safe
 manner.

[See in context](./src/commands/generateOpenAPITypes.ts#L13-L18)



#### 5.3.2. Open API generator

Here, we reuse the Open API handler to generate the
 definition of the API right inside a CLI command.

[See in context](./src/commands/generateOpenAPISchema.ts#L8-L12)



### 5.4. Constants

First of all the autoloader looks for constants in the
 previously loaded `APP_CONFIG` configurations hash.

[See in context](./src/services/_autoload.ts#L166-L169)



### 5.4. Testing

In such a hard life, Whook's make it simple to
 also test your commands.

[See in context](./src/commands/generateOpenAPISchema.test.ts#L6-L10)



### 5.5. Handlers map

Here, we build the handlers map needed by the router by injecting every
 handler required by the API.

[See in context](./src/services/_autoload.ts#L184-L187)



### 5.6. Service/handler loading

Finally, we either require the handler/service module if
 none of the previous strategies applyed.

[See in context](./src/services/_autoload.ts#L211-L214)



#### 5.6.1. WhookInitializerMap

Whook exports a `WhookInitializerMap` type to help you ensure yours are valid.

[See in context](./src/services/_autoload.ts#L38-L40)



### 5.7. Service name mapping

In order to be able to substituate easily a service per another
 one can specify a mapping between a service and its substitution.

[See in context](./src/services/_autoload.ts#L151-L154)



#### 5.7.1. WhookServiceMap

Whook exports a `WhookServiceMap` type to help you ensure yours are valid.

[See in context](./src/services/_autoload.ts#L34-L36)



### 5.8. Initializer path mapping

In order to be able to load a service from a given path map
 one can directly specify a path to use for its resolution.

[See in context](./src/services/_autoload.ts#L246-L249)



## 6. IP detection

If no `HOST` configuration is specified in dependencies nor in ENV,
 this service detects the machine host automagically.

[See in context](./src/services/HOST.ts#L7-L10)



## 7. Port detection

If no `PORT` configuration is specified in dependencies nor in ENV,
this service detects a free port automagically.

[See in context](./src/services/PORT.ts#L7-L10)



## 9. Plugins paths

Whook auto loader can look for initializers in a list of
 plugins defined in the `WHOOK_PLUGINS` constant. This
 service computes the path where those plugins source are
 located allowing one to use services/handlers from it.

[See in context](./src/services/WHOOK_PLUGINS_PATHS.ts#L6-L12)



## 10. Commands

Whook's commands are CLI tools that you may need to create and
 use with your Whook's projects.

By doing so, it provides you a convenient way to reuse your
Whook's project configuration, services and handlers easily
 in you day to day command line programs.

To test this project, go to a project (in this repo
 `@whook/example`) and run:

```sh
cd packages/whook
npm run build
cd ../whook-example

# Debugging compiled commands
node ../whook/bin/whook.js ls

# Debugging source commands
PROJECT_SRC="$PWD/src" NODE_ENV=${NODE_ENV:-development} npm run cli -- ts-node --esm --files -- ../whook/bin/whook.js ls
```

[See in context](./src/cli.ts#L11-L35)



## 10. API definitions loader

The `API_DEFINITIONS` service provide a convenient way to
 gather your various API definitions from the handlers you
 created in the `src/handlers` folder.

[See in context](./src/services/API_DEFINITIONS.ts#L23-L27)

