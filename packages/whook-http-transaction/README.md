[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/http-transaction
> Isolated HTTP Transactions for the Whook framework

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/master/packages/whook-http-transaction/LICENSE)
[![NPM version](https://badge.fury.io/js/%40whook%2Fhttp-transaction.svg)](https://npmjs.org/package/@whook/http-transaction)


[//]: # (::contents:start)

Whook takes a very unusual direction when it comes to dealing with
 HTTP transactions. It makes requests and responses serializable to:
- only work with functions that take request and return responses
- have [easily unit testable](https://github.com/nfroidure/whook/blob/e7470fed860a8e1644b15625c9db4dd8198b70a6/packages/whook-example/src/handlers/putEcho.test.js)
 handlers.

This service is intended to build those objects from Node HTTP ones
 before passing them to the handlers. It also keeps track of running
 queries and ensure it is well handled by the server before releasing
 it.

[//]: # (::contents:end)

# API
## Functions

<dl>
<dt><a href="#default">default(services)</a> ⇒ <code><a href="#WhookHTTPTransaction">Promise.&lt;WhookHTTPTransaction&gt;</a></code></dt>
<dd><p>Instantiate the httpTransaction service</p>
</dd>
<dt><a href="#initAPM">initAPM(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Application monitoring service that simply log stringified contents.</p>
</dd>
<dt><a href="#initObfuscator">initObfuscator(constants)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Allow to proxy constants directly by serializing it in the
 build, saving some computing and increasing boot time of
 lambdas.</p>
</dd>
</dl>

## Typedefs

<dl>
<dt><a href="#WhookHTTPTransaction">WhookHTTPTransaction</a></dt>
<dd></dd>
</dl>

<a name="default"></a>

## default(services) ⇒ [<code>Promise.&lt;WhookHTTPTransaction&gt;</code>](#WhookHTTPTransaction)
Instantiate the httpTransaction service

**Kind**: global function  
**Returns**: [<code>Promise.&lt;WhookHTTPTransaction&gt;</code>](#WhookHTTPTransaction) - A promise of the httpTransaction function  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services to inject |
| [services.TIMEOUT] | <code>Number</code> | <code>30000</code> | A number indicating how many ms the transaction  should take to complete before being cancelled. |
| [services.TRANSACTIONS] | <code>Object</code> | <code>{}</code> | A hash of every current transactions |
| services.delay | <code>Object</code> |  | A delaying service |
| services.obfuscator | <code>Object</code> |  | A service to avoid logging sensible informations |
| [services.log] | <code>function</code> |  | A logging function |
| [services.apm] | <code>function</code> |  | An apm function |
| [services.time] | <code>function</code> |  | A timing function |
| [services.uniqueId] | <code>function</code> |  | A function returning unique identifiers |

**Example**  
```js
import initHTTPTransaction from '@whook/http-transaction';

const httpTransaction = await initHTTPTransaction({
  log: console.log.bind(console),
  time: Date.now.bind(Date),
});
```
<a name="initAPM"></a>

## initAPM(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Application monitoring service that simply log stringified contents.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of the apm service.  

| Param | Type | Description |
| --- | --- | --- |
| services | <code>Object</code> | The services to inject |
| [services.log] | <code>function</code> | A logging function |

<a name="initObfuscator"></a>

## initObfuscator(constants) ⇒ <code>Promise.&lt;Object&gt;</code>
Allow to proxy constants directly by serializing it in the
 build, saving some computing and increasing boot time of
 lambdas.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the gathered constants.  

| Param | Type | Description |
| --- | --- | --- |
| constants | <code>Object</code> | The serializable constants to gather |

**Example**  
```js
import { initBuildConstants } from '@whook/aws-lambda';
import { alsoInject } from 'knifecycle';

export default alsoInject(['MY_OWN_CONSTANT'], initBuildConstants);
```
<a name="WhookHTTPTransaction"></a>

## WhookHTTPTransaction
**Kind**: global typedef  

* [WhookHTTPTransaction](#WhookHTTPTransaction)
    * [.id](#WhookHTTPTransaction.id)
    * [.start](#WhookHTTPTransaction.start) ⇒ <code>Promise.&lt;Object&gt;</code>
    * [.catch](#WhookHTTPTransaction.catch) ⇒ <code>Promise</code>
    * [.end](#WhookHTTPTransaction.end) ⇒ <code>Promise.&lt;Object&gt;</code>

<a name="WhookHTTPTransaction.id"></a>

### WhookHTTPTransaction.id
Id of the transaction

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
<a name="WhookHTTPTransaction.start"></a>

### WhookHTTPTransaction.start ⇒ <code>Promise.&lt;Object&gt;</code>
Start the transaction

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise to be resolved with the signed token.  

| Param | Type | Description |
| --- | --- | --- |
| buildResponse | <code>function</code> | A function that builds a response |

<a name="WhookHTTPTransaction.catch"></a>

### WhookHTTPTransaction.catch ⇒ <code>Promise</code>
Catch a transaction error

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
**Returns**: <code>Promise</code> - A promise to be resolved with the signed token.  

| Param | Type | Description |
| --- | --- | --- |
| err | <code>Error</code> | A function that builds a response |

<a name="WhookHTTPTransaction.end"></a>

### WhookHTTPTransaction.end ⇒ <code>Promise.&lt;Object&gt;</code>
End the transaction

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise to be resolved with the signed token.  

| Param | Type | Description |
| --- | --- | --- |
| response | <code>Object</code> | A response for the transaction |


# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/master/packages/whook-http-transaction/LICENSE)
