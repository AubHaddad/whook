[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/http-transaction
> Isolated HTTP Transactions for the Whook framework

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/master/packages/whook-http-transaction/LICENSE)
[![NPM version](https://badge.fury.io/js/%40whook%2Fhttp-transaction.svg)](https://npmjs.org/package/@whook/http-transaction)


[//]: # (::contents:start)

[Whook](https://github.com/nfroidure/whook) takes a very unusual direction
 when it comes to dealing with HTTP transactions. It makes requests and
 responses serializable to:
- only work with functions that take request and return responses (
 allowing your handlers to be pure functions),
- have [easily unit testable](https://github.com/nfroidure/whook/blob/e7470fed860a8e1644b15625c9db4dd8198b70a6/packages/whook-example/src/handlers/putEcho.test.js)
 handlers thanks to concise snapshots.

This service is intended to build those objects from Node HTTP ones
 before passing them to the handlers. It also keeps track of running
 queries and ensure it is well handled by the server before releasing
 it.

[//]: # (::contents:end)

# API
## Functions

<dl>
<dt><a href="#default">default(services)</a> ⇒ <code><a href="#WhookHTTPTransaction">Promise.&lt;WhookHTTPTransaction&gt;</a></code></dt>
<dd><p>Instantiate the httpTransaction service</p>
</dd>
<dt><a href="#initAPM">initAPM(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Application monitoring service that simply log stringified contents.</p>
</dd>
<dt><a href="#initObfuscator">initObfuscator(services)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Obfuscate sensible informations.</p>
</dd>
</dl>

## Typedefs

<dl>
<dt><a href="#WhookHTTPTransaction">WhookHTTPTransaction</a></dt>
<dd></dd>
</dl>

<a name="default"></a>

## default(services) ⇒ [<code>Promise.&lt;WhookHTTPTransaction&gt;</code>](#WhookHTTPTransaction)
Instantiate the httpTransaction service

**Kind**: global function  
**Returns**: [<code>Promise.&lt;WhookHTTPTransaction&gt;</code>](#WhookHTTPTransaction) - A promise of the httpTransaction function  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services to inject |
| [services.TIMEOUT] | <code>Number</code> | <code>30000</code> | A number indicating how many ms the transaction  should take to complete before being cancelled. |
| [services.TRANSACTIONS] | <code>Object</code> | <code>{}</code> | A hash of every current transactions |
| services.delay | <code>Object</code> |  | A delaying service |
| services.obfuscator | <code>Object</code> |  | A service to avoid logging sensible informations |
| [services.log] | <code>function</code> |  | A logging function |
| [services.apm] | <code>function</code> |  | An apm function |
| [services.time] | <code>function</code> |  | A timing function |
| [services.uniqueId] | <code>function</code> |  | A function returning unique identifiers |

**Example**  
```js
import initHTTPTransaction from '@whook/http-transaction';

const httpTransaction = await initHTTPTransaction({
  log: console.log.bind(console),
  time: Date.now.bind(Date),
});
```
<a name="initAPM"></a>

## initAPM(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Application monitoring service that simply log stringified contents.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of the apm service.  

| Param | Type | Description |
| --- | --- | --- |
| services | <code>Object</code> | The services to inject |
| [services.log] | <code>function</code> | A logging function |

<a name="initObfuscator"></a>

## initObfuscator(services) ⇒ <code>Promise.&lt;Object&gt;</code>
Obfuscate sensible informations.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the gathered constants.  

| Param | Type | Description |
| --- | --- | --- |
| services | <code>Object</code> | The service dependend on |
| [services.SHIELD_CHAR] | <code>Object</code> | The char for replacing sensible informations |
| [services.MAX_CLEAR_CHARS] | <code>Object</code> | The maximum clear chars to display |
| [services.MAX_CLEAR_RATIO] | <code>Object</code> | The maximum clear chars ratio to display |
| [services.SENSIBLE_PROPS] | <code>Object</code> | Sensible properties names |
| [services.SENSIBLE_HEADERS] | <code>Object</code> | Sensible headers names |

**Example**  
```js
import { initObfuscator } from '@whook/http-transaction';
import { alsoInject } from 'knifecycle';

const obfuscator = await initObfuscator();

console.log(obfuscator('my very secret information!));
// my ...on!
```
<a name="WhookHTTPTransaction"></a>

## WhookHTTPTransaction
**Kind**: global typedef  

* [WhookHTTPTransaction](#WhookHTTPTransaction)
    * [.id](#WhookHTTPTransaction.id)
    * [.start](#WhookHTTPTransaction.start) ⇒ <code>Promise.&lt;Object&gt;</code>
    * [.catch](#WhookHTTPTransaction.catch) ⇒ <code>Promise</code>
    * [.end](#WhookHTTPTransaction.end) ⇒ <code>Promise.&lt;Object&gt;</code>

<a name="WhookHTTPTransaction.id"></a>

### WhookHTTPTransaction.id
Id of the transaction

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
<a name="WhookHTTPTransaction.start"></a>

### WhookHTTPTransaction.start ⇒ <code>Promise.&lt;Object&gt;</code>
Start the transaction

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise to be resolved with the signed token.  

| Param | Type | Description |
| --- | --- | --- |
| buildResponse | <code>function</code> | A function that builds a response |

<a name="WhookHTTPTransaction.catch"></a>

### WhookHTTPTransaction.catch ⇒ <code>Promise</code>
Catch a transaction error

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
**Returns**: <code>Promise</code> - A promise to be resolved with the signed token.  

| Param | Type | Description |
| --- | --- | --- |
| err | <code>Error</code> | A function that builds a response |

<a name="WhookHTTPTransaction.end"></a>

### WhookHTTPTransaction.end ⇒ <code>Promise.&lt;Object&gt;</code>
End the transaction

**Kind**: static property of [<code>WhookHTTPTransaction</code>](#WhookHTTPTransaction)  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise to be resolved with the signed token.  

| Param | Type | Description |
| --- | --- | --- |
| response | <code>Object</code> | A response for the transaction |


# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/master/packages/whook-http-transaction/LICENSE)
