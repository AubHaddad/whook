[//]: # ( )
[//]: # (This file is automatically generated by the `jsarch`)
[//]: # (module. Do not change it elsewhere, changes would)
[//]: # (be overriden.)
[//]: # ( )
# Architecture Notes



## HTTP Transactions

The `httpTransaction` service creates a new transaction
 for every single HTTP request incoming. It helps
 ensuring each request receives a response and avoid
 idle requests via a configurable timeout.

It is also a convenient abstraction of the actual
 request/response between the router and
 the NodeJS world. A common need is to fake the
 HTTP method for backward compatibility with old
 browsers/proxies by using the
 `X-HTTP-Method-Override` header.

You can simply do this by wrapping this service. See
 [`@whook/method-override`](../whook-method-override/README.md)
 for a working example.

[See in context](./src/index.ts#L104-L121)



### New Transaction

The idea is to maintain a hash of each pending
 transaction. To do so, we create a transaction
 object that contains useful informations about
 the transaction and we store it into the
 `TRANSACTIONS` hash.

Each transaction has a unique id that is either
 generated or picked up in the `Transaction-Id`
 request header. This allows to trace
 transactions end to end with that unique id.

[See in context](./src/index.ts#L202-L213)



### Transaction start

Once initiated, the transaction can be started. It
   basically spawns a promise that will be resolved
   to the actual response or rejected if the timeout
   is reached.

[See in context](./src/index.ts#L294-L299)



### Transaction errors

Here we are simply casting and logging errors.
   It is important for debugging but also for
   ending the transaction properly if an error
   occurs.

[See in context](./src/index.ts#L321-L326)



### Transaction end

We end the transaction by writing the final status
   and headers and piping the response body if any.

  The transaction can till error at that time but it
   is too late for changing the response status so
   we are just logging the event.
   This could be handled with
   [HTTP trailers](https://nodejs.org/api/http.html#http_response_addtrailers_headers)
   but the lack of client side support for now is
   preventing us to use them.

   Once terminated, the transaction is removed
from the `TRANSACTIONS` hash.

[See in context](./src/index.ts#L371-L385)

