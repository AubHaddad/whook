[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/aws-lambda
> Build and deploy to AWS Lambda with Whook.

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/master/packages/whook-aws-lambda/LICENSE)
[![NPM version](https://badge.fury.io/js/%40whook%2Faws-lambda.svg)](https://npmjs.org/package/@whook/aws-lambda)


[//]: # (::contents:start)

This module is aimed to help you to deploy your Whook server
 to AWS Lambda.

## Testing commands

Building lambdas is done by creating the build script in your project `bin`
 folder :
```sh
cat "#! /usr/bin/env node

const { runBuild } = require('../dist/index');

runBuild();
" > bin/build.js
```

And add create the runBuild function in you `index.ts` main file :
```diff
+ import {
+   initBuildConstants,
+   runBuild as runBaseBuild,
+   prepareBuildEnvironment as prepareBaseBuildEnvironment,
+ } from '@whook/aws-lambda';
+
+ // The `runBuild` function is intended to build the
+ // project
+
+ export async function runBuild(
+   innerPrepareEnvironment = prepareBuildEnvironment,
+ ): Promise<void> {
+   return runBaseBuild(innerPrepareEnvironment);
+ }
+
+ export async function prepareBuildEnvironment(
+   $: Knifecycle = new Knifecycle(),
+ ): Promise<Knifecycle> {
+   $ = await prepareEnvironment($);
+   $ = await prepareBaseBuildEnvironment($);
+
+   $.register(
+     constant('INITIALIZER_PATH_MAP', {
+       ENV: require.resolve('@whook/aws-lambda/dist/services/ENV'),
+       log: require.resolve('@whook/aws-lambda/dist/services/log'),
+       apm: require.resolve('@whook/http-transaction/dist/services/apm'),
+       obfuscator: require.resolve(
+         '@whook/http-transaction/dist/services/obfuscator',
+       ),
+       time: require.resolve('common-services/dist/time'),
+       delay: require.resolve('common-services/dist/delay'),
+     }),
+   );
+   $.register(alsoInject(['API_DEFINITIONS'], initBuildConstants));
+
+   return $;
+ } 
```

Also add the following lines in your `package.json` file :
```diff
  scripts: {
+    "build": "NODE_ENV=${NODE_ENV:-development} node bin/build",
  },
  devDependencies: {
+    "@whook/aws-lambda": "^3.1.3",
+    "@whook/http-transaction": "^3.1.3",
+    "babel-loader": "^8.0.6",
+    "babel-plugin-knifecycle": "^1.1.1",
+    "webpack": "4.41.5"
  }
```

To build your lambdas :
```sh
# Build all lambdas
npm run compile && npm run build
# Build only one lambda
npm run compile && npm run build -- getPing
```

You can easily test your lambda builds by adding `@whook/aws-lambda`
 to your `WHOOK_PLUGINS` list. It provides you some commands like
 the `testHTTPLambda` one:
```sh
npm run whook -- testHTTPLambda --name getPing
```

[//]: # (::contents:end)

# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/master/packages/whook-aws-lambda/LICENSE)
