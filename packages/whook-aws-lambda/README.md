[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/aws-lambda
> Build and deploy to AWS Lambda with Whook.

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/master/packages/whook-aws-lambda/LICENSE)
[![NPM version](https://badge.fury.io/js/%40whook%2Faws-lambda.svg)](https://npmjs.org/package/@whook/aws-lambda)


[//]: # (::contents:start)

This module is aimed to help you to build and deploy your Whook server to
[AWS Lambda](https://aws.amazon.com/en/lambda/).

You can find a complete setup with a Terraform deployment example in
[this pull request](https://github.com/nfroidure/whook/pull/54).

## Quick setup

Install this module and its peer dependencies :

```sh
npm i @whook/aws-lambda;
npm i --save-dev @whook/http-transaction esbuild
```

Add this module to your Whook plugins and tweak the 2 build functions in your
`build.ts` main file:

```diff
- import YError from 'yerror';
+import {
+  runBuild as runBaseBuild,
+  prepareBuildEnvironment as prepareBaseBuildEnvironment,
+} from '@whook/aws-lambda';

// (...)

export async function prepareEnvironment(
  $: Knifecycle = new Knifecycle(),
): Promise<Knifecycle> {

  // (...)

  // Setup your own whook plugins or avoid whook defaults by leaving it empty
-  $.register(constant('WHOOK_PLUGINS', ['@whook/cli', '@whook/whook']));
+  $.register(constant('WHOOK_PLUGINS', [
+    '@whook/aws-lambda',
+    '@whook/cli',
+    '@whook/whook',
+  ]));

  // (...)

}

// (...)

// The `runBuild` function is intended to build the
// project
export async function runBuild(
  innerPrepareEnvironment = prepareBuildEnvironment,
): Promise<void> {
-  throw new YError('E_NO_BUILD_IMPLEMENTED');

  // Usually, here you call the installed build
-  // return runBaseBuild(innerPrepareEnvironment);
+   return runBaseBuild(innerPrepareEnvironment);
}

// (...)

// The `prepareBuildEnvironment` create the build
//  environment
export async function prepareBuildEnvironment(
  $: Knifecycle = new Knifecycle(),
): Promise<Knifecycle> {
  $ = await prepareEnvironment($);

  // (...)

-  // Usually, here you call the installed build env
-  // $ = await prepareBaseBuildEnvironment($);
+  // Calling the AWS specific build env
+  $ = await prepareBaseBuildEnvironment($);


  // The build often need to know were initializers
  //  can be found to create a static build and
  //  remove the need to create an injector
  $.register(
    constant('INITIALIZER_PATH_MAP', {
      // (...)
      obfuscator: '@whook/http-transaction/dist/services/obfuscator',
-      log: 'common-services/dist/log',
+      log: '@whook/aws-lambda/dist/services/log',
      time: 'common-services/dist/time',
      delay: 'common-services/dist/delay',
    }),
  );

  // (...)

}
```

And add the AWS Lambda config (usually in `src/config/common/config.js`):

```diff
+ import type { WhookCompilerConfig } from '@whook/whook';
+ import type {
+   WhookAPIOperationGCPFunctionConfig
+ } from '@whook/aws-lambda';

// ...

export type AppConfigs = WhookConfigs &
+  WhookCompilerConfig &
  APIConfig;

const CONFIG: AppConfigs = {
  // ...
+  COMPILER_OPTIONS: {
+    externalModules: [],
+    ignoredModules: [],
+    target: '14',
+  },
};

// Export custom handlers definitions
export type APIHandlerDefinition = WhookAPIHandlerDefinition<
+  WhookAPIOperationAWSLambdaConfig &
  WhookAPIOperationSwaggerConfig
>;

export default CONFIG;
```

# Build

To build your functions :

```sh
# Build all functions
npm run compile && npm run build

# Build only one function
npm run compile && npm run build -- getPing
```

# Debug

You can easily test your function builds by adding `@whook/aws-lambda` to your
`WHOOK_PLUGINS` list. It provides you some commands like the `testHTTPLambda`
one:

```sh
npx whook testHTTPLambda --name getPing
```

To get more insights when errors happens:

```sh
npm run whook-dev -- testHTTPLambda --name getPing
```

## Deployment

We recommend using [Terraform](https://terraform.io) to deploy your lambda
functions.

There is a complete example on how to deploy your functions
[in this pull request](https://github.com/nfroidure/whook/pull/54).

[//]: # (::contents:end)

# API

# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/master/packages/whook-aws-lambda/LICENSE)
