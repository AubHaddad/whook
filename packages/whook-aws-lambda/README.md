[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/aws-lambda
> Build and deploy to AWS Lambda with Whook.

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/master/packages/whook-aws-lambda/LICENSE)
[![NPM version](https://badge.fury.io/js/%40whook%2Faws-lambda.svg)](https://npmjs.org/package/@whook/aws-lambda)


[//]: # (::contents:start)

This module is aimed to help you to deploy your Whook server
 to AWS Lambda.

## Testing commands

Building lambdas is done by creating the build script in your project `bin`
 folder :
```sh
cat "#! /usr/bin/env node

const { runBuild } = require('../dist/index');

runBuild();
" > bin/build.js
```

And add create the runBuild function in you `index.ts` main file :
```diff
+ import {
+   initBuildConstants,
+   runBuild as runBaseBuild,
+   prepareBuildEnvironment as prepareBaseBuildEnvironment,
+ } from '@whook/aws-lambda';
+
+ // The `runBuild` function is intended to build the
+ // project
+
+ export async function runBuild(
+   innerPrepareEnvironment = prepareBuildEnvironment,
+ ): Promise<void> {
+   return runBaseBuild(innerPrepareEnvironment);
+ }
+
+ export async function prepareBuildEnvironment(
+   $: Knifecycle = new Knifecycle(),
+ ): Promise<Knifecycle> {
+   $ = await prepareEnvironment($);
+   $ = await prepareBaseBuildEnvironment($);
+
+   $.register(
+     constant('INITIALIZER_PATH_MAP', {
+       ENV: require.resolve('@whook/aws-lambda/dist/services/ENV'),
+       log: require.resolve('@whook/aws-lambda/dist/services/log'),
+       apm: require.resolve('@whook/http-transaction/dist/services/apm'),
+       obfuscator: require.resolve(
+         '@whook/http-transaction/dist/services/obfuscator',
+       ),
+       time: require.resolve('common-services/dist/time'),
+       delay: require.resolve('common-services/dist/delay'),
+     }),
+   );
+   $.register(alsoInject(['API_DEFINITIONS'], initBuildConstants));
+
+   return $;
+ } 
```

Also add the following lines in your `package.json` file :
```diff
  scripts: {
+    "build": "NODE_ENV=${NODE_ENV:-development} node bin/build",
  },
  devDependencies: {
+    "@whook/aws-lambda": "^3.1.3",
+    "@whook/http-transaction": "^3.1.3",
+    "babel-loader": "^8.0.6",
+    "babel-plugin-knifecycle": "^1.2.0",
+    "webpack": "4.41.5"
  }
```

To build your lambdas :
```sh
# Build all lambdas
npm run compile && npm run build
# Build only one lambda
npm run compile && npm run build -- getPing
```

You can easily test your lambda builds by adding `@whook/aws-lambda`
 to your `WHOOK_PLUGINS` list. It provides you some commands like
 the `testHTTPLambda` one:
```sh
npm run whook -- testHTTPLambda --name getPing
```

[//]: # (::contents:end)

# API
## Members

<dl>
<dt><a href="#default">default</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Wrap the ENV service in order to filter ENV vars for the build</p>
</dd>
</dl>

## Functions

<dl>
<dt><a href="#initBuildConstants">initBuildConstants(constants)</a> ⇒ <code>Promise.&lt;Object&gt;</code></dt>
<dd><p>Allow to proxy constants directly by serializing it in the
 build, saving some computing and increasing boot time of
 lambdas.</p>
</dd>
</dl>

<a name="default"></a>

## default ⇒ <code>Promise.&lt;Object&gt;</code>
Wrap the ENV service in order to filter ENV vars for the build

**Kind**: global variable  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the reshaped env vars.  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| services | <code>Object</code> |  | The services ENV depends on |
| services.NODE_ENV | <code>Object</code> |  | The injected NODE_ENV value to add it to the build env |
| [services.PROXYED_ENV_VARS] | <code>Object</code> | <code>{}</code> | A list of environment variable names to proxy |
| [log] | <code>Object</code> | <code>noop</code> | An optional logging service |

<a name="initBuildConstants"></a>

## initBuildConstants(constants) ⇒ <code>Promise.&lt;Object&gt;</code>
Allow to proxy constants directly by serializing it in the
 build, saving some computing and increasing boot time of
 lambdas.

**Kind**: global function  
**Returns**: <code>Promise.&lt;Object&gt;</code> - A promise of an object containing the gathered constants.  

| Param | Type | Description |
| --- | --- | --- |
| constants | <code>Object</code> | The serializable constants to gather |

**Example**  
```js
import { initBuildConstants } from '@whook/aws-lambda';
import { alsoInject } from 'knifecycle';

export default alsoInject(['MY_OWN_CONSTANT'], initBuildConstants);
```

# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/master/packages/whook-aws-lambda/LICENSE)
