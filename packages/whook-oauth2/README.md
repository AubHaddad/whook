[//]: # ( )
[//]: # (This file is automatically generated by a `metapak`)
[//]: # (module. Do not change it  except between the)
[//]: # (`content:start/end` flags, your changes would)
[//]: # (be overridden.)
[//]: # ( )
# @whook/oauth2
> OAuth2 implementation for Whook servers

[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/nfroidure/whook/blob/master/packages/whook-oauth2/LICENSE)
[![NPM version](https://badge.fury.io/js/%40whook%2Foauth2.svg)](https://npmjs.org/package/@whook/oauth2)


[//]: # (::contents:start)

This module is aimed to allow you to easily bring OAuth2 to your
[Whook](https://github.com/nfroidure/whook) server. It must be used with a
server side rendered frontend that brings the UI that allows users to
authenticate and allow client applications to act on behalf of them.

![Code Flow Overview](./code_flow_overview.svg)

The module provides :
- 3 handlers : the 2 OAuth2 standard endpoints (`getOAuth2authorize` and
  `postOAuth2Tokentoken`) plus the `postOAuth2Acknowledge` to be used by the SSR
  frontend,
- the 5 OAuth2 standard grant types implemented through plug and play services.
  You can create your own granter services to create additional grant types.

This module requires you to implement some services it relies on:
- `oAuth2AccessToken` that generates and checks the `access_token` and the
  `oAuth2RefreshToken` for the `refresh_token` both have the same interface,
- `checkApplication` service that is supposed to check whether an application
  can be used or not for a given grant type, a given scope and redirect URI,
- `oAuth2PasswordService` aimed to check the `password` grant type with your own
  logic (if you use it),
- `oAuth2ClientCredentialsService` aimed to check the `client_credential` grant
  type with your own logic (if you use it),
- `OAuth2CodeService` aimed to check the `code` grant type with your own logic
  (if you use it).

## Quick setup

Install the module in your project:
```sh
npm i @whook/oauth2
```

Declare the plugin into your `index.ts` file:
```diff
  // (...)

  // Setup your own whook plugins or avoid whook defaults by leaving it empty
-  $.register(constant('WHOOK_PLUGINS', ['@whook/cli', '@whook/whook']));
+  $.register(constant('WHOOK_PLUGINS', ['@whook/oauth2', '@whook/cli', '@whook/whook']));

  // (...)
```

Add the OAuth2 configuration to your config files:
```diff
+ import {
+   OAUTH2_ERRORS_DESCRIPTORS,
+   OAuth2Config,
+ } from '@whook/oauth2';

// ...

export type AppConfigs = WhookConfigs &
+  OAuth2Config &
  APIConfig;

const CONFIG: AppConfigs = {
  // ...
+   OAUTH2: {
+     // The SSR frontend
+     authenticateURL: 'https://auth.example.com',
+   }
-   ERRORS_DESCRIPTORS: DEFAULT_ERRORS_DESCRIPTORS,
+   ERRORS_DESCRIPTORS: {
+     ...DEFAULT_ERRORS_DESCRIPTORS,
+     ...OAUTH2_ERRORS_DESCRIPTORS,
+   },
  // ...
};

export default CONFIG;
```

## Using your own grant types

The `oAuth2Granters` service gather the various granters services you can use in
your application but you can write your own that uses a subset or a superset of
these granters.

## Customizing handlers

The endpoints definitions are designed to support the standard OAuth2
definitions but can be easily overriden.

You will probably need to protect the `postOAuth2Token` endpoint
 with your own security mecanism :
```ts
// In a `src/handlers/postOAuth2Token.ts` fileimport {
  initPostOAuth2Token,
  postOAuth2TokenDefinition,
  postOAuth2TokenAuthorizationCodeTokenRequestBodySchema,
  postOAuth2TokenPasswordTokenRequestBodySchema,
  postOAuth2TokenClientCredentialsTokenRequestBodySchema,
  postOAuth2TokenRefreshTokenRequestBodySchema,
  postOAuth2TokenTokenBodySchema,
} from '@whook/oauth2';
import type { WhookAPIHandlerDefinition } from '@whook/whook';

export default initPostOAuth2Token;

export const definition: WhookAPIHandlerDefinition = {
  ...postOAuth2TokenDefinition,
  operation: {
    ...postOAuth2TokenDefinition.operation,
    security: [
      {
        basicAuth: ['admin'],
      },
    ],
  },
};

export {
  postOAuth2TokenAuthorizationCodeTokenRequestBodySchema,
  postOAuth2TokenPasswordTokenRequestBodySchema,
  postOAuth2TokenClientCredentialsTokenRequestBodySchema,
  postOAuth2TokenRefreshTokenRequestBodySchema,
  postOAuth2TokenTokenBodySchema,
};
```

Or you may want to reduce the OAuth2 grant types supported:

```ts
// In a `src/handlers/getOAuth2Authorize.ts` file
import {
  initGetOAuth2Authorize,
  getOAuth2AuthorizeDefinition as definition,
  getOAuth2AuthorizeResponseTypeParameter as baseResponseTypeParameter,
  getOAuth2AuthorizeClientIdParameter as clientIdParameter,
  getOAuth2AuthorizeRedirectURIParameter as redirectURIParameter,
  getOAuth2AuthorizeScopeParameter as scopeParameter,
  getOAuth2AuthorizeStateParameter as stateParameter,
} from '@whook/oauth2';

export default initGetOAuth2Authorize;

export {
  definition,
  clientIdParameter,
  redirectURIParameter,
  scopeParameter,
  stateParameter,
};

export const responseTypeParameter = {
  ...baseResponseTypeParameter,
  parameter: {
    ...baseResponseTypeParameter.parameter,
    schema: {
      ...baseResponseTypeParameter.parameter.schema,
      enum: ['code'], // Allow only the 'code' grant type
    },
  },
};
```

[//]: # (::contents:end)



[//]: # (::contents:end)

# API

# Authors
- [Nicolas Froidure](http://insertafter.com/en/index.html)

# License
[MIT](https://github.com/nfroidure/whook/blob/master/packages/whook-oauth2/LICENSE)
